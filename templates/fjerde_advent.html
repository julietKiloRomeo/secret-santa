{% extends 'base.html' %}
{% block title %}Fjerde Advent{% endblock %}
{% block body_attrs %}data-immersive-stage="reindeer-rush" data-immersive-active="0"{% endblock %}
{% block content %}
  <div class="max-w-4xl mx-auto p-6 space-y-6" aria-live="polite">
    <section class="rounded-2xl bg-white/90 p-5 text-gray-900 shadow-xl space-y-2 text-center">
      <p class="text-sm text-gray-600">Player: <strong>{{ default_name|default('Nisse') }}</strong></p>
      <p class="text-lg font-semibold">Distance: <span id="reindeer-score">0 m</span></p>
      <p class="font-semibold">Score: <span id="reindeer-total-score">0 pts</span></p>
      <p class="text-sm text-gray-600">Bonus: <span id="reindeer-bonus">0 pts</span></p>
      <p class="text-sm text-gray-600">Tap/Space to start running · Swipe down to slide · Swipe right to dash</p>
      <p class="text-xs text-gray-500">Speed: <strong id="reindeer-speed">0</strong> px/s · Obstacles: <strong id="reindeer-obstacles">0</strong> · Next item: <strong id="reindeer-next-item">—</strong></p>
    </section>
    <section id="reindeer-pwa-cta" class="rounded-2xl bg-blue-900/70 p-4 text-sm text-white shadow-lg flex flex-col gap-2 items-center" hidden>
      <p class="font-semibold text-center">Install Reindeer Rush for full-screen play</p>
      <button
        id="reindeer-install-pwa"
        type="button"
        class="px-4 py-2 rounded-full bg-amber-400 text-blue-900 font-bold shadow hover:bg-amber-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-300"
        hidden
      >
        Install on this device
      </button>
      <p id="reindeer-install-ios-hint" class="text-xs text-amber-100 text-center" hidden>
        On iPhone: tap the Share icon and choose "Add to Home Screen" to play fullscreen.
      </p>
    </section>
  </div>

  <div id="reindeer-immersive-stage" class="reindeer-immersive-stage" aria-hidden="true">
    <div class="reindeer-immersive-backdrop"></div>
    <div class="reindeer-immersive-frame" role="application" aria-label="Reindeer Rush full-screen canvas">
      <div id="reindeer-canvas" class="reindeer-immersive-canvas" role="presentation">Tap or press space to start running</div>
    </div>
    <p id="reindeer-immersive-hint" class="reindeer-immersive-hint">Rotate for landscape play</p>
    <button type="button" id="reindeer-exit-immersive" class="reindeer-immersive-exit" aria-label="Exit Reindeer Rush landscape mode">Exit scenic view</button>
  </div>
  <a
    href="/"
    class="fixed left-4 bottom-4 z-50 inline-flex items-center gap-2 rounded-full bg-white/15 px-4 py-2 text-sm font-semibold text-white shadow-lg backdrop-blur border border-white/20 hover:bg-white/25"
  >
    ← Til forsiden
  </a>

  <script>window.__defaultPlayerName__ = "{{ default_name|default('Nisse') }}";</script>
  <script src="{{ url_for('static', filename='arcade_overlay.js') }}"></script>
  <script src="{{ url_for('static', filename='leaderboard_buttons.js') }}"></script>
  <script src="{{ url_for('static', filename='matter.min.js') }}"></script>
  <script src="/static/reindeer_gestures.js"></script>
  <script src="/static/reindeer_ground.js"></script>
  <script src="/static/reindeer_rush.js"></script>
  <script>
    (function () {
      const cta = document.getElementById('reindeer-pwa-cta');
      const installBtn = document.getElementById('reindeer-install-pwa');
      const iosHint = document.getElementById('reindeer-install-ios-hint');
      if (!cta) return;
      const isiOS = /iphone|ipad|ipod/i.test(navigator.userAgent || '');
      const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
      let deferredPrompt = null;

      function showCTA() {
        cta.hidden = false;
        if (!deferredPrompt && installBtn) {
          installBtn.hidden = true;
        }
      }

      window.addEventListener('beforeinstallprompt', (event) => {
        event.preventDefault();
        deferredPrompt = event;
        if (installBtn) installBtn.hidden = false;
        showCTA();
      });

      if (installBtn) {
        installBtn.addEventListener('click', async () => {
          if (!deferredPrompt) return;
          installBtn.disabled = true;
          deferredPrompt.prompt();
          await deferredPrompt.userChoice;
          installBtn.disabled = false;
          installBtn.hidden = true;
          deferredPrompt = null;
        });
      }

      if (isiOS && !isStandalone) {
        if (iosHint) iosHint.hidden = false;
        showCTA();
      }
    })();
  </script>
{% endblock %}

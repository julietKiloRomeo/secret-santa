{% extends 'base.html' %}
{% block title %}Admin{% endblock %}
{% block content %}
  <div class="container">
    <h1>Admin Panel (Year {{ year }})</h1>

    <section>
      <h2>Sæt adgangskode</h2>
      <form onsubmit="return setPassword(event);">
        <input type="text" id="userName" placeholder="Brugernavn (fornavn)" required />
        <input type="text" id="userPass" placeholder="Kodeord (fx horse-staple-orange)" required />
        <button type="submit">Gem adgangskode</button>
      </form>
      <div id="setPassMsg"></div>
    </section>

    <section style="margin-top: 2rem;">
      <h2>Kør årets matcher</h2>
      <button onclick="runMatches()">Kør matcher</button>
      <div id="matchesMsg"></div>
    </section>

    <section style="margin-top: 2rem;">
      <h2>Spil (tænd/sluk)</h2>
      <div id="gamesList">Indlæser...</div>
    </section>

    <section style="margin-top: 2rem;">
      <h2>Nulstil high scores</h2>
      <div id="resetMsg"></div>
    </section>
    </div>

  <script>
    async function setPassword(e) {
      e.preventDefault();
      const name = document.getElementById('userName').value.trim();
      const passphrase = document.getElementById('userPass').value.trim();
      const resp = await fetch('/api/admin/set_password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, passphrase })
      });
      const data = await resp.json();
      document.getElementById('setPassMsg').textContent = data.success ? 'Adgangskode gemt' : (data.error || 'Fejl');
      return false;
    }

    async function runMatches() {
      const resp = await fetch('/api/admin/run_matches', { method: 'POST' });
      const data = await resp.json();
      document.getElementById('matchesMsg').textContent = data.success ? `Matcher gemt for år ${data.year}` : (data.error || 'Fejl');
    }

    // Games management
    async function loadGames() {
      const resp = await fetch('/api/admin/games');
      const data = await resp.json();
      const list = document.getElementById('gamesList');
      list.innerHTML = '';
      data.games.forEach(g => {
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.gap = '0.5rem';
        row.style.alignItems = 'center';
        const label = document.createElement('div');
        label.textContent = g.game;
        const toggle = document.createElement('input');
        toggle.type = 'checkbox';
        toggle.checked = g.enabled;
        toggle.addEventListener('change', async () => {
          await toggleGame(g.game, toggle.checked);
          loadGames();
        });
        const reset = document.createElement('button');
        reset.textContent = 'Nulstil scores';
        reset.addEventListener('click', async () => {
          const r = await fetch('/api/admin/reset_scores', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ game: g.game }) });
          const d = await r.json();
          document.getElementById('resetMsg').textContent = d.success ? `Scores nulstilt for ${g.game}` : (d.error || 'Fejl');
          loadGames();
        });
        row.appendChild(label);
        row.appendChild(toggle);
        row.appendChild(reset);
        list.appendChild(row);
      });
    }

    async function toggleGame(game, enabled) {
      await fetch('/api/admin/set_game', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ game, enabled }) });
    }

    // Load games on page load
    loadGames();
  </script>
{% endblock %}

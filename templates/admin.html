{% extends 'base.html' %}
{% block title %}Admin{% endblock %}
{% block content %}
  <div class="max-w-6xl mx-auto space-y-6 px-4 pb-20">
    <div class="grid gap-4 lg:grid-cols-2">
      <section class="bg-white/5 border border-white/10 rounded-3xl p-6 shadow-lg">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h1 class="text-2xl font-semibold">Admin Panel ({{ year }})</h1>
            <p class="text-sm text-white/70">Manage participant logins and match draws.</p>
          </div>
          <span class="text-xs uppercase tracking-widest text-white/60">Secure area</span>
        </div>
        <form id="set-password-form" data-js="set-password-form" class="space-y-3" onsubmit="return setPassword(event);">
          <div>
            <label for="userName" class="text-xs font-semibold uppercase text-white/60">Vælg bruger</label>
            <select id="userName" required class="mt-1 block w-full rounded-xl border border-white/20 bg-slate-900/40 px-3 py-2 text-white">
              <option value="" disabled selected>-- vælg bruger --</option>
              {% for u in users %}
                <option value="{{ u }}">{{ u }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label for="userPass" class="text-xs font-semibold uppercase text-white/60">Passphrase</label>
            <input type="text" id="userPass" placeholder="e.g. sparkling-winter-berry" required class="mt-1 block w-full rounded-xl border border-white/20 bg-slate-900/40 px-3 py-2 text-white" />
          </div>
          <button type="submit" class="w-full rounded-2xl bg-emerald-500/90 px-4 py-2 text-white font-semibold shadow-lg hover:bg-emerald-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-300">Gem adgangskode</button>
          <p id="setPassMsg" data-js="set-pass-msg" class="text-sm text-white/70"></p>
        </form>
      </section>

      <section class="bg-white/5 border border-white/10 rounded-3xl p-6 shadow-lg flex flex-col justify-between">
        <div>
          <h2 class="text-xl font-semibold mb-1">Kør årets matcher</h2>
          <p class="text-sm text-white/70 mb-4">Træk matches igen når deltagerlisten er opdateret.</p>
        </div>
        <div class="flex items-center gap-3">
          <button id="runMatchesBtn" data-js="run-matches-btn" class="flex-1 rounded-2xl bg-blue-500/90 px-4 py-2 text-white font-semibold hover:bg-blue-400 disabled:opacity-60 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-300" {% if draw_locked %}disabled{% endif %} onclick="runMatches()">Kør matcher</button>
          {% if draw_locked %}
            <span class="text-sm text-red-300">Trækning låst</span>
          {% endif %}
        </div>
        <p id="matchesMsg" class="mt-3 text-sm text-white/70"></p>
      </section>
    </div>

    <section class="bg-white/5 border border-white/10 rounded-3xl p-6 shadow-lg">
      <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h2 class="text-xl font-semibold">Spilstyring</h2>
          <p class="text-sm text-white/70">Aktiver eller deaktiver minis spil fra oversigten.</p>
        </div>
        <span class="inline-flex items-center rounded-full bg-white/10 px-3 py-1 text-xs font-semibold uppercase tracking-wider text-white/70">Live status</span>
      </div>
      <div id="gamesList" data-js="games-list" class="mt-5 grid gap-4"></div>
      <p id="gamesMessage" data-js="reset-msg" class="mt-4 text-sm text-white/70">Hver handling opdaterer oversigten.</p>
    </section>
  </div>

  <script>
    const gameMetadata = {
      'forste-advent': { title: 'Første Advent', desc: 'Jule Snake' },
      'anden-advent': { title: 'Anden Advent', desc: 'Flappy Santa' },
      'tredje-advent': { title: 'Tredje Advent', desc: 'Reindeer Rush (endless runner)' },
      'fjerde-advent': { title: 'Fjerde Advent', desc: 'Under konstruktion' },
      'glaedelig-jul': { title: 'Glædelig Jul', desc: 'Julehilsner' },
    };

    function getMsgEl(id) {
      return document.getElementById(id);
    }

    async function setPassword(event) {
      event.preventDefault();
      const name = document.getElementById('userName').value.trim();
      const passphrase = document.getElementById('userPass').value.trim();
      const resp = await fetch('/api/admin/set_password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, passphrase })
      });
      const data = await resp.json();
      const setPassMsg = getMsgEl('setPassMsg');
      if (setPassMsg) {
        setPassMsg.textContent = data.success ? 'Adgangskode gemt' : (data.error || 'Fejl');
        setPassMsg.className = data.success ? 'text-sm text-emerald-300' : 'text-sm text-amber-300';
      }
      return false;
    }

    async function runMatches() {
      const btn = getMsgEl('runMatchesBtn');
      const matchesMsg = getMsgEl('matchesMsg');
      if (btn && btn.disabled) {
        if (matchesMsg) matchesMsg.textContent = 'Drawing locked by server configuration.';
        return;
      }
      if (btn) btn.disabled = true;
      const resp = await fetch('/api/admin/run_matches', { method: 'POST' });
      const data = await resp.json();
      if (matchesMsg) {
        matchesMsg.textContent = data.success ? `Matcher gemt for år ${data.year}` : (data.error || 'Fejl');
        matchesMsg.className = data.success ? 'text-sm text-emerald-300' : 'text-sm text-amber-300';
      }
      if (btn) btn.disabled = false;
    }

    async function loadGames() {
      const resp = await fetch('/api/admin/games');
      const data = await resp.json();
      const list = document.getElementById('gamesList');
      if (!list) return;
      list.innerHTML = '';
      data.games.sort((a, b) => a.game.localeCompare(b.game)).forEach((game) => {
        const meta = gameMetadata[game.game] || { title: game.game, desc: '' };
        const card = document.createElement('article');
        card.className = 'rounded-2xl border border-white/10 bg-slate-900/40 p-4 shadow-inner transition hover:border-emerald-300/40';
        const header = document.createElement('div');
        header.className = 'flex items-start justify-between gap-4';
        const titles = document.createElement('div');
        const title = document.createElement('h3');
        title.className = 'text-lg font-semibold';
        title.textContent = meta.title;
        titles.appendChild(title);
        if (meta.desc) {
          const desc = document.createElement('p');
          desc.className = 'text-sm text-white/60';
          desc.textContent = meta.desc;
          titles.appendChild(desc);
        }
        const badge = document.createElement('span');
        badge.textContent = game.enabled ? 'Aktiv' : 'Deaktiv';
        badge.className = `rounded-full px-3 py-1 text-xs font-semibold ${game.enabled ? 'bg-emerald-500/20 text-emerald-200' : 'bg-amber-500/20 text-amber-200'}`;
        header.appendChild(titles);
        header.appendChild(badge);

        const actions = document.createElement('div');
        actions.className = 'mt-4 flex flex-wrap gap-3';
        const toggleBtn = document.createElement('button');
        toggleBtn.className = 'rounded-full border border-white/20 px-4 py-1 text-sm font-semibold text-white transition hover:border-white/70';
        toggleBtn.textContent = game.enabled ? 'Deaktiver' : 'Aktiver';
        toggleBtn.addEventListener('click', async () => {
          toggleBtn.disabled = true;
          await toggleGame(game.game, !game.enabled);
          toggleBtn.disabled = false;
        });
        const resetBtn = document.createElement('button');
        resetBtn.className = 'rounded-full border border-white/20 px-4 py-1 text-sm font-semibold text-white transition hover:border-white/70';
        resetBtn.textContent = 'Nulstil high scores';
        resetBtn.addEventListener('click', async () => {
          resetBtn.disabled = true;
          await resetScores(game.game);
          resetBtn.disabled = false;
        });
        actions.appendChild(toggleBtn);
        actions.appendChild(resetBtn);

        card.appendChild(header);
        card.appendChild(actions);
        list.appendChild(card);
      });
    }

    async function toggleGame(game, enabled) {
      const resp = await fetch('/api/admin/set_game', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ game, enabled })
      });
      const data = await resp.json();
      updateGamesMessage(data.success ? `${game} er ${enabled ? 'aktiveret' : 'deaktiveret'}.` : (data.error || 'Fejl ved opdatering.'), data.success);
      if (data.success) {
        await loadGames();
      }
    }

    async function resetScores(game) {
      const resp = await fetch('/api/admin/reset_scores', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ game })
      });
      const data = await resp.json();
      updateGamesMessage(data.success ? `High scores nulstillet for ${game}.` : (data.error || 'Fejl ved nulstilling.'), data.success);
      if (data.success) {
        await loadGames();
      }
    }

    function updateGamesMessage(text, success = true) {
      const msg = getMsgEl('gamesMessage');
      if (!msg) return;
      msg.textContent = text;
      msg.className = `mt-4 text-sm ${success ? 'text-emerald-300' : 'text-amber-300'}`;
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadGames();
    });
  </script>
{% endblock %}

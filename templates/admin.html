{% extends 'base.html' %}
{% block title %}Admin{% endblock %}
{% block content %}
  <div class="bg-red-900 bg-opacity-80 rounded-xl shadow-lg p-6 max-w-2xl mx-auto w-full">
    <h1 class="text-2xl font-bold mb-4">Admin Panel (Year {{ year }})</h1>

    <section>
      <h2 class="text-lg font-semibold mb-2">Sæt adgangskode</h2>
      <div class="bg-white/5 p-4 rounded-lg shadow mb-4">
        <form data-js="set-password-form" class="grid grid-cols-1 gap-3" onsubmit="return setPassword(event);">
          <label for="userName">Vælg bruger</label>
          <select id="userName" required class="block w-full rounded-md border border-gray-300 bg-white text-gray-900 px-3 py-2 shadow-sm sm:text-sm">
            <option value="" disabled selected>-- vælg bruger --</option>
            {% for u in users %}
              <option value="{{ u }}">{{ u }}</option>
            {% endfor %}
          </select>

          <label for="userPass">Passphrase</label>
          <input type="text" id="userPass" placeholder="Kodeord (fx horse-staple-orange)" required class="block w-full rounded-md border border-gray-300 bg-white text-gray-900 px-3 py-2 shadow-sm sm:text-sm" />

          <div>
            <button type="submit" class="btn btn-primary bg-green-600 text-white py-2 px-3 rounded-md">Gem adgangskode</button>
          </div>
        </form>
        <div id="setPassMsg" data-js="set-pass-msg" class="mt-2 text-gray-300"></div>
      </div>
    </section>

    <section class="mt-4">
      <h2 class="text-lg font-semibold mb-2">Kør årets matcher</h2>
      <button id="runMatchesBtn" data-js="run-matches-btn" onclick="runMatches()" class="btn btn-primary bg-blue-600 text-white py-2 px-3 rounded-md" {% if draw_locked %}disabled{% endif %}>Kør matcher</button>
      {% if draw_locked %}
        <div class="text-red-400 mt-2">Drawing is locked by server configuration (DRAW_LOCKED).</div>
      {% endif %}
      <div id="matchesMsg" data-js="matches-msg" class="mt-2"></div>
    </section>

    <section class="mt-4">
      <h2 class="text-lg font-semibold mb-2">Spil (tænd/sluk)</h2>
      <div id="gamesList" data-js="games-list">Indlæser...</div>
    </section>

    <section class="mt-4">
      <h2 class="text-lg font-semibold mb-2">Nulstil high scores</h2>
      <div id="resetMsg" data-js="reset-msg"></div>
    </section>
  </div>

  <script>
    async function setPassword(e) {
      e.preventDefault();
      const name = document.getElementById('userName').value.trim();
      const passphrase = document.getElementById('userPass').value.trim();
      const resp = await fetch('/api/admin/set_password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, passphrase })
      });
      const data = await resp.json();
      const setPassMsg = document.querySelector('[data-js="set-pass-msg"]') || document.getElementById('setPassMsg');
      if (setPassMsg) setPassMsg.textContent = data.success ? 'Adgangskode gemt' : (data.error || 'Fejl');
      return false;
    }

    async function runMatches() {
      const btn = document.querySelector('[data-js="run-matches-btn"]') || document.getElementById('runMatchesBtn');
      const matchesMsg = document.querySelector('[data-js="matches-msg"]') || document.getElementById('matchesMsg');
      if (btn && btn.disabled) {
        if (matchesMsg) matchesMsg.textContent = 'Drawing of matches is locked by server configuration (DRAW_LOCKED).';
        return;
      }
      const resp = await fetch('/api/admin/run_matches', { method: 'POST' });
      const data = await resp.json();
      if (matchesMsg) matchesMsg.textContent = data.success ? `Matcher gemt for år ${data.year}` : (data.error || 'Fejl');
    }

    // Games management
    async function loadGames() {
      const resp = await fetch('/api/admin/games');
      const data = await resp.json();
      const list = document.querySelector('[data-js="games-list"]') || document.getElementById('gamesList');
      list.innerHTML = '';
      data.games.forEach(g => {
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.gap = '0.5rem';
        row.style.alignItems = 'center';
        const label = document.createElement('div');
        label.textContent = g.game;
        const toggle = document.createElement('input');
        toggle.type = 'checkbox';
        toggle.checked = g.enabled;
        toggle.addEventListener('change', async () => {
          await toggleGame(g.game, toggle.checked);
          loadGames();
        });
        const reset = document.createElement('button');
        reset.textContent = 'Nulstil scores';
        reset.addEventListener('click', async () => {
          const r = await fetch('/api/admin/reset_scores', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ game: g.game }) });
          const d = await r.json();
          const resetMsg = document.querySelector('[data-js="reset-msg"]') || document.getElementById('resetMsg');
          if (resetMsg) resetMsg.textContent = d.success ? `Scores nulstilt for ${g.game}` : (d.error || 'Fejl');
          loadGames();
        });
        row.appendChild(label);
        row.appendChild(toggle);
        row.appendChild(reset);
        list.appendChild(row);
      });
    }

    async function toggleGame(game, enabled) {
      await fetch('/api/admin/set_game', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ game, enabled }) });
    }

    // Load games on page load
    loadGames();
  </script>
{% endblock %}
